name: Apply patch to oxc-node

on:
  workflow_dispatch:

jobs:
  apply_patch:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v6
        with:
          repository: oxc-project/oxc-node
          ref: v0.0.35
          path: oxc-node
      - name: apply patch
        working-directory: oxc-node
        shell: bash
        run: |
          git apply <<'PATCH'
          diff --git a/.cargo/config.toml b/.cargo/config.toml
          index dda5ea5..3e8417f 100644
          --- a/.cargo/config.toml
          +++ b/.cargo/config.toml
          @@ -1,4 +1,4 @@
          -[target.'cfg(target_env = "gnu")']
          +[target.'cfg(all(target_env = "gnu", target_os = "linux"))']
           rustflags = ["-C", "link-args=-Wl,-z,nodelete"]

           [target.x86_64-pc-windows-msvc]
          @@ -10,7 +10,7 @@ rustflags = ["-C", "target-feature=+crt-static"]
           [target.aarch64-pc-windows-msvc]
           rustflags = ["-C", "target-feature=+crt-static"]

          -[target.'cfg(target_os = "windows")']
          +[target.'cfg(all(target_os = "windows", target_env = "msvc"))']
           rustflags = [
             # Disables linking against the default Universal C Runtime (libucrt.lib). This prevents conflicts if another CRT library is linked manually.
             "-C",
          @@ -21,6 +21,9 @@ rustflags = [
             "link-args=/DEFAULTLIB:ucrt.lib",
           ]

          +[target.x86_64-pc-windows-gnu]
          +rustflags = [ "-C", "link-arg=-ladvapi32" ]
          +
           # LLD linker is currently broken for us, opt out.
           # https://blog.rust-lang.org/2025/09/18/Rust-1.90.0/#what-s-in-1-90-0-stable
           [target.x86_64-unknown-linux-gnu]
          PATCH
          git diff
      - name: create package.json
        shell: bash
        run: |
          cat > package.json <<'JSON'
          {
            "name": "rolldown-binding-builder",
            "private": true,
            "type": "module",
            "scripts": {
              "build": "node ./build-binding.mjs"
            },
            "napi": {
              "binaryName": "rolldown-binding",
              "packageName": "@rolldown/binding",
              "targets": [
                "x86_64-apple-darwin",
                "x86_64-pc-windows-msvc",
                "x86_64-unknown-linux-gnu",
                "x86_64-unknown-linux-musl",
                "x86_64-unknown-freebsd",
                "i686-pc-windows-msvc",
                "armv7-unknown-linux-gnueabihf",
                "aarch64-unknown-linux-gnu",
                "aarch64-apple-darwin",
                "aarch64-unknown-linux-musl",
                "aarch64-unknown-linux-ohos",
                "aarch64-pc-windows-msvc",
                "aarch64-linux-android",
                "wasm32-wasip1-threads"
              ],
              "wasm": {
                "initialMemory": 16384,
                "browser": {
                  "fs": true,
                  "asyncInit": true
                }
              },
              "dtsHeader": "type MaybePromise<T> = T | Promise<T>\ntype Nullable<T> = T | null | undefined\ntype VoidNullable<T = void> = T | null | undefined | void\nexport type BindingStringOrRegex = string | RegExp\ntype BindingResult<T> = { errors: BindingError[], isBindingErrors: boolean } | T\n\n"
            },
            "dependencies": {
              "@napi-rs/cli": "3.4.1",
              "glob": "11.0.3"
            }
          }
          JSON
          cat package.json
