name: Build napi-rs with its dependencies

env:
  DEBUG: "napi:*"
  RUST_BACKTRACE: full
  # https://github.com/nodejs/node/issues/51555#issuecomment-2290742072
  DISABLE_V8_COMPILE_CACHE: 1

on:
  push:
    branches:
      - main
    paths:
      - ".github/workflows/ci.yml"
      - "patches/**/*.patch"
  pull_request:
    branches:
      - main
    paths:
      - ".github/workflows/ci.yml"
      - "patches/**/*.patch"

jobs:
  build:
    env:
      OXC_NODE_FOR_ROLLDOWN_REF: "v0.0.32"
      OXC_NODE_FOR_NAPI_REF: "v0.0.34"
      NAPI_RS_REF: "napi-v3.5.2"
      ROLLDOWN_REF: "v1.0.0-beta.47"
    strategy:
      fail-fast: false
      matrix:
        sys: [UCRT64, CLANG64, MINGW64, CLANGARM64]
    runs-on: ${{ matrix.sys == 'CLANGARM64' && 'windows-11-arm' || 'windows-latest' }}

    steps:
      - uses: actions/checkout@v6

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: ${{ matrix.sys }}
          update: false
          install: >-
            git
            curl
          pacboy: >-
            toolchain:p
            cmake:p
            rust:p
            yarn:p
            ${{ (matrix.sys == 'CLANG64' || matrix.sys == 'CLANGARM64') && 'gcc-compat:p' || '' }}

      - name: Show working directory (Windows)
        shell: pwsh
        run: |
          Get-Location
          ls

      - name: Echo System Info
        shell: msys2 {0}
        run: |
          echo "MSYSTEM = $MSYSTEM"
          uname -a
          pacman -Q msys2-runtime || true
          cargo -Vv
          pwd

      - name: Prepare artifacts directory
        shell: msys2 {0}
        run: mkdir ~/$MSYSTEM-artifacts/

      - name: Prepare oxc-node for rolldown
        uses: ./.github/actions/oxc-node-prepare
        with:
          ref: ${{ env.OXC_NODE_FOR_ROLLDOWN_REF }}
          dir: oxc-node-${{ env.OXC_NODE_FOR_ROLLDOWN_REF }}

      - name: Prepare oxc-node for napi-rs
        uses: ./.github/actions/oxc-node-prepare
        with:
          ref: ${{ env.OXC_NODE_FOR_NAPI_REF }}
          dir: oxc-node-${{ env.OXC_NODE_FOR_NAPI_REF }}

      - name: Prepare rolldown
        shell: msys2 {0}
        run: |
          git clone --depth 1 --branch $ROLLDOWN_REF https://github.com/rolldown/rolldown

      - name: Prepare napi-rs
        shell: msys2 {0}
        run: |
          git clone --depth 1 --branch $NAPI_RS_REF https://github.com/napi-rs/napi-rs
          cd napi-rs
          git apply -v ../patches/napi-rs-use-patched-napi-cli.patch

      - name: Cache cargo build artifacts
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.USERPROFILE }}\.cargo\registry
            ${{ env.USERPROFILE }}\.cargo\git
            oxc-node-${{ env.OXC_NODE_FOR_NAPI_REF }}/target
            oxc-node-${{ env.OXC_NODE_FOR_ROLLDOWN_REF }}/target
            rolldown/target
            napi-rs/target
          key: ${{ runner.os }}-${{ matrix.sys }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.sys }}-cargo-

      - name: Cache node_modules (oxc-node for rolldown)
        uses: ./.github/actions/oxc-node-cache-node-modules
        with:
          dir: oxc-node-${{ env.OXC_NODE_FOR_ROLLDOWN_REF }}
          sys: ${{ matrix.sys }}

      - name: Cache node_modules (oxc-node for napi-rs)
        uses: ./.github/actions/oxc-node-cache-node-modules
        with:
          dir: oxc-node-${{ env.OXC_NODE_FOR_NAPI_REF }}
          sys: ${{ matrix.sys }}

      - name: Cache node_modules (rolldown / pnpm)
        if: ${{ false }}
        uses: actions/cache@v4
        with:
          path: |
            rolldown/node_modules
          key: ${{ runner.os }}-${{ matrix.sys }}-node-rolldown-${{ hashFiles('rolldown/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.sys }}-node-rolldown-

      - name: Cache node_modules (napi-rs / yarn)
        uses: actions/cache@v4
        with:
          path: |
            napi-rs/node_modules
          key: ${{ runner.os }}-${{ matrix.sys }}-node-napi-${{ hashFiles('napi-rs/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.sys }}-node-napi-

      - name: Build oxc-node for rolldown
        uses: ./.github/actions/oxc-node-build
        with:
          ref: ${{ env.OXC_NODE_FOR_ROLLDOWN_REF }}
          dir: oxc-node-${{ env.OXC_NODE_FOR_ROLLDOWN_REF }}

      - name: Build oxc-node for napi-rs
        uses: ./.github/actions/oxc-node-build
        with:
          ref: ${{ env.OXC_NODE_FOR_NAPI_REF }}
          dir: oxc-node-${{ env.OXC_NODE_FOR_NAPI_REF }}

      - name: Build rolldown
        shell: msys2 {0}
        run: |
          mkdir -p rolldown/dummy/rolldown-binding-builder
          # at the moment `build-binding.ts` is a valid mjs file, use the similar structure
          # so we don't need to update path inside of this script
          cp rolldown/packages/rolldown/build-binding.ts rolldown/dummy/rolldown-binding-builder/build-binding.mjs
          # HACK Luckily only two packages are imported by `build-binding.mjs`
          # Cannot use the regular way to install packages, because it looks like that
          # some scripts are executed when running `pnpm install`, even with the flag `--ignore-scripts`
          cp patches/rolldown.$ROLLDOWN_REF/rolldown-binding-builder/package.json rolldown/dummy/rolldown-binding-builder/
          RS_TARGET_ARCH=$(rustc -vV | grep '^host:' | awk '{print $2}')
          cd rolldown/dummy/rolldown-binding-builder
          npm install
          node ./build-binding.mjs
          # src is generated by napi, it contains the .node, .d.cts and .cjs file
          cp -r src ~/$MSYSTEM-artifacts/rolldown-$ROLLDOWN_REF/

      - name: Build napi-rs
        shell: msys2 {0}
        run: |
          cd napi-rs
          yarn install --mode=skip-build --immutable
          RS_TARGET_ARCH=$(rustc -vV | grep '^host:' | awk '{print $2}')
          NODE_ARTIFACT=node_modules/@oxc-node/core-win32-x64-msvc/oxc-node.win32-x64-msvc.node
          if [ "$MSYSTEM" = "CLANGARM64" ]; then
            NODE_ARTIFACT=node_modules/@oxc-node/core-win32-arm64-msvc/oxc-node.win32-arm64-msvc.node
          fi

          # HACK: loaded by napi-raw
          cp ~/$MSYSTEM-artifacts/oxc_node-$OXC_NODE_FOR_NAPI_REF.dll $NODE_ARTIFACT

          yarn workspace @examples/napi build

      - name: Test napi-rs (with patch)
        shell: msys2 {0}
        run: |
          cd napi-rs

          # HACK: use rolldown dll built in the previous step
          # HACK: on CLANG64 `-gnu` is loaded instead of `-gnullvm`, a bug related to napi-cli itself
          #       on CLANGARM64, use `win32-arm64-msvc`
          NODE_ARTIFACT=node_modules/rolldown/dist/shared/rolldown-binding.win32-x64-gnu.node
          if [ "$MSYSTEM" = "CLANGARM64" ]; then
            NODE_ARTIFACT=node_modules/rolldown/dist/shared/rolldown-binding.win32-arm64-msvc.node
          fi
          cp ~/$MSYSTEM-artifacts/rolldown-$ROLLDOWN_REF/rolldown-binding.*.node $NODE_ARTIFACT
          # also `.node` related
          git apply -v ../patches/examples-napi-__tests__-unload-spec-js.patch

          yarn test:cli
          # restore, remove the package @ironblood/napi-cli-build to pass the test
          git checkout examples/napi/package.json
          yarn workspace @examples/napi test

          yarn tsc -p examples/napi/tsconfig.json --noEmit --skipLibCheck

          yarn test:macro
          cargo test

          # Electron tests
          node ./node_modules/electron/install.js
          yarn test:electron

          # Test build with profile
          yarn workspace @examples/napi build --profile napi-rs-custom
