name: Build napi-rs with its dependencies

on:
  push:
    branches:
      - main
    paths:
      - ".github/workflows/ci.yml"
      - "patches/oxc-node.cargo-config.patch"
  pull_request:
    branches:
      - main
    paths:
      - ".github/workflows/ci.yml"
      - "patches/oxc-node.cargo-config.patch"

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        sys: [UCRT64, CLANG64, MINGW64, CLANGARM64]
    runs-on: ${{ matrix.sys == 'CLANGARM64' && 'windows-11-arm' || 'windows-latest' }}

    steps:
      - uses: actions/checkout@v6

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: ${{ matrix.sys }}
          update: false
          install: >-
            git
            curl
          pacboy: >-
            toolchain:p
            cmake:p
            rust:p
            yarn:p
            ${{ (matrix.sys == 'CLANG64' || matrix.sys == 'CLANGARM64') && 'gcc-compat:p' || '' }}

      - name: Show working directory (Windows)
        shell: pwsh
        run: |
          Get-Location
          ls

      - name: Echo System Info
        shell: msys2 {0}
        run: |
          echo "MSYSTEM = $MSYSTEM"
          uname -a
          pacman -Q msys2-runtime || true
          cargo -Vv
          pwd

      - name: Prepare oxs-node with patch
        shell: msys2 {0}
        run: |
          git clone --depth 1 https://github.com/oxc-project/oxc-node
          cd oxc-node
          git apply -v ../patches/oxc-node.cargo-config.patch

      - name: Prepare napi-rs
        shell: msys2 {0}
        run: |
          git clone --depth 1 https://github.com/napi-rs/napi-rs

      - name: Cache cargo build artifacts
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.USERPROFILE }}\.cargo\registry
            ${{ env.USERPROFILE }}\.cargo\git
            oxc-node/target
            napi-rs/target
          key: ${{ runner.os }}-${{ matrix.sys }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.sys }}-cargo-

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: |
            napi-rs/node_modules
          key: ${{ runner.os }}-${{ matrix.sys }}-node-${{ hashFiles('napi-rs/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.sys }}-node-

      - name: Build oxc-node
        shell: msys2 {0}
        run: |
          cd oxc-node
          TARGET=$(rustc -vV | grep '^host:' | awk '{print $2}')
          cargo build --release --target $TARGET

      - name: Build napi-rs
        shell: msys2 {0}
        run: |
          cd napi-rs
          yarn install --mode=skip-build --immutable
          TARGET=$(rustc -vV | grep '^host:' | awk '{print $2}')
          NODE_ARTIFACT=node_modules/@oxc-node/core-win32-x64-msvc/oxc-node.win32-x64-msvc.node
          if [ "$MSYSTEM" = "CLANGARM64" ]; then
            NODE_ARTIFACT=node_modules/@oxc-node/core-win32-arm64-msvc/oxc-node.win32-arm64-msvc.node
          fi

          # HACK: loaded by napi-raw
          cp ../oxc-node/target/$TARGET/release/oxc_node.dll $NODE_ARTIFACT

          yarn workspace @examples/napi build
